"use strict";(function(t,e){e.EasyBooking=e.EasyBooking||{},EasyBooking.calcMode=EASYBOOKING.calc_mode,EasyBooking.maxOption=new Date(EASYBOOKING.last_date+"T00:00:00"),EasyBooking.firstWeekday="0"!=EASYBOOKING.first_weekday?"monday":"sunday",EasyBooking.allowDisabled=EASYBOOKING.allow_disabled,EasyBooking.Helper={formatPrice:function(t){return accounting.formatMoney(t,{symbol:EASYBOOKING.currency_format_symbol,decimal:EASYBOOKING.currency_format_decimal_sep,thousand:EASYBOOKING.currency_format_thousand_sep,precision:EASYBOOKING.currency_format_num_decimals,format:EASYBOOKING.currency_format})}},EasyBooking.DateHelper={isDate:function(t){return t instanceof Date},isDay:function(t){return!isNaN(t)&&t>=1&&t<=7},isArray:function(t){return t instanceof Array},isObject:function(t){return"object"==typeof t&&!(t instanceof Date)},createDateObject:function(t){let e={};return t||(t=new Date),"infinity"===t?(e={date:1/0,day:1/0,month:1/0,obj:1/0,pick:1/0,year:1/0},e):EasyBooking.DateHelper.isDate(t)?(t.setHours(0,0,0,0),e={date:t.getDate(),day:t.getDay(),month:t.getMonth(),obj:t,pick:t.getTime(),year:t.getFullYear()},e):e},isDisabled:function(t,e){if(void 0===t||!EasyBooking.DateHelper.isDate(e))return!1;e.setHours(0,0,0,0);const i=e.getTime(),a=e.getDay();return t.some(function(t){if(EasyBooking.DateHelper.isArray(t)){if(t=new Date(t[0],t[1],t[2]),i===t.getTime())return!0}else if(EasyBooking.DateHelper.isObject(t)){let a=new Date(t["from"][0],t["from"][1],t["from"][2]),r=new Date(t["to"][0],t["to"][1],t["to"][2]);if(i>=a&&e<=r)return!0}else if(EasyBooking.DateHelper.isDay(t)){let e=a;if("monday"===EasyBooking.firstWeekday&&0===e?e=7:"sunday"===EasyBooking.firstWeekday&&(e+=1),t===e)return!0}else if(EasyBooking.DateHelper.isDate(t)&&i===t.getTime())return!0})},addDays:function(t,e){let i=new Date(t);return i.setDate(i.getDate()+e),i.setHours(0,0,0,0),i},removeDays:function(t,e){let i=new Date(t);return i.setDate(i.getDate()-e),i.setHours(0,0,0,0),i}},EasyBooking.Datepickers=function(){class i{constructor(t){if(new.target===i)throw new Error("You cannot instantiate an abstract class!");if(!t.length)return!1;this.$cart=t,this.$picker_wrap=this.$cart.find(".wceb_picker_wrap"),this.$reset_dates=this.$cart.find("a.reset_dates"),this.$booking_price=this.$cart.find(".booking_price"),this.$add_to_cart_button=this.$cart.find(".single_add_to_cart_button"),this.$qty_input=this.$cart.find('input[name="quantity"]'),this.$main_qty_input=this.$qty_input,this.createProduct(),this.PAO_form="undefined"!=typeof WC_PAO?WC_PAO.initialized_forms.find(t=>t.$el[0].isEqualNode(this.$cart[0])):void 0,this.addons={},void 0!==this.product.id&&(this.$inputStart=this.$cart.find(".wceb_datepicker_start").pickadate(),this.$inputEnd=this.$cart.find(".wceb_datepicker_end").pickadate(),this.createPickers(),this.StartPicker.otherPicker=this.EndPicker,this.EndPicker.otherPicker=this.StartPicker,this.events(),this.init()),this.dynamicNonce=new s}createProduct(){this.product=new a(this)}createPickers(){this.StartPicker=new r(this,"start"),this.EndPicker=new r(this,"end")}events(){var i=this;i.$reset_dates.on("click",function(t){t.preventDefault(),i.init()}).hide(),i.$qty_input.on("change",function(t){i.updateTotals(),t.stopPropagation()}),i.$cart.on("clear_start_date clear_end_date",function(){i.clearBookingPrice()}),i.$cart.on("updated_addons",function(){void 0!==i.PAO_form&&JSON.stringify(i.addons)!==JSON.stringify(i.PAO_form.totals.addons_price_data)&&(i.addons=Object.assign([],i.PAO_form.totals.addons_price_data),i.updateTotals())}),i.$add_to_cart_button.on("click",function(a){!t(this).is(".disabled, .date-selection-needed")||t(this).hasClass("wc-variation-selection-needed")||t(this).hasClass("wc-variation-is-unavailable")||(a.preventDefault(),e.alert(i.product.select_dates_message),a.stopPropagation())}),i.StartPicker.pickerObject.on({before_render:function(){"two"===i.product.booking_dates&&i.EndPicker.isSet()&&i.StartPicker.applyBookingDuration(!0)},after_render:function(){},render:function(){i.StartPicker.display(),"two"===i.product.booking_dates&&(i.StartPicker.pickerItem.disable=i.StartPicker.getDisabled())},set:function(t){i.StartPicker.set(t),void 0!==t.select&&null!==t.select&&i.hasSelectedDates()&&i.calcBookingPrice()},close:function(){i.StartPicker.close()}}),i.EndPicker.pickerObject.on({before_render:function(){"two"===i.product.booking_dates&&i.StartPicker.isSet()&&i.EndPicker.applyBookingDuration()},render:function(){i.EndPicker.display(),"two"===i.product.booking_dates&&(i.EndPicker.pickerItem.disable=i.EndPicker.getDisabled())},after_render:function(){},set:function(t){i.EndPicker.set(t),void 0!==t.select&&null!==t.select&&i.hasSelectedDates()&&i.calcBookingPrice()},close:function(){i.EndPicker.close()}})}init(){this.initPickers(),this.clearBookingPrice(),this.$reset_dates.hide()}initPickers(){this.$cart.trigger("pickers_init",this),this.StartPicker.clear(),this.EndPicker.clear(),this.StartPicker.reset(),this.EndPicker.reset(),this.$cart.trigger("after_pickers_init",this)}clearBookingPrice(){this.$booking_price.find(".price").html(""),this.$cart.find(".booking_details").html(""),this.$add_to_cart_button.addClass("date-selection-needed")}async calcBookingPrice(){var e=this;let i={product_id:e.product.id,quantity:e.$qty_input.val(),variation_id:e.product.variation_id,children:e.product.selectedIDs,start_format:e.StartPicker.pickerObject.get("select","yyyy-mm-dd"),additional_cost:e.getAdditionalCosts("each")};"two"===e.product.booking_dates&&(i.end_format=e.EndPicker.pickerObject.get("select","yyyy-mm-dd")),e.$cart.find(".woocommerce-error, .woocommerce-message").remove(),e.$cart.attr("aria-busy","true").fadeTo("400","0.6").css("cursor","wait");try{const a=await this.dynamicNonce.getNonce(),r=await fetch(EASYBOOKING.rest_url+"easybooking/v1/date-selection/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({security:a,...i})}),s=await r.json();if(!s.success&&(s.message||s.error))throw new Error(s.message||s.error);s.fragments&&(t.each(s.fragments,function(t,i){e.$cart.find(t).replaceWith(i)}),e.updatePrice(s.fragments.booking_price,""!==s.fragments.booking_regular_price?s.fragments.booking_regular_price:s.fragments.booking_price,!1)),e.$cart.trigger("update_price",s),e.$add_to_cart_button.removeClass("date-selection-needed")}catch(t){e.$picker_wrap.prepend(`<div class="wceb_error woocommerce-error">${t.message}</div>`),e.init()}finally{e.$cart.attr("aria-busy","false").fadeTo(0,"1").css("cursor","auto")}}hasSelectedDates(){return!!("one"===this.product.booking_dates&&this.StartPicker.isSet()||"two"===this.product.booking_dates&&this.StartPicker.isSet()&&this.EndPicker.isSet())}getPrice(t="price"){let e=parseFloat(this.$booking_price.attr("regular"===t?"data-booking_regular_price":"data-booking_price"));return this.hasSelectedDates()||(e+=parseFloat(this.getAdditionalCosts("total")),e*=void 0!==this.$main_qty_input.val()?parseFloat(this.$main_qty_input.val()):1),e}getRegularPrice(){return this.getPrice("regular")}getPriceHtml(t=!0){let e=this.getPrice(),i=this.getRegularPrice(),a=`<span class="woocommerce-Price-amount amount">${EasyBooking.Helper.formatPrice(e)}</span>${this.product.price_suffix}`;if(e!==i){let t=`<span class="woocommerce-Price-amount amount">${EasyBooking.Helper.formatPrice(i)}</span>${this.product.price_suffix}`;a=`<del>${t}</del> <ins>${a}</ins>`}return`<span class="price">${a}${t?` <span class="wceb_price_format">${this.product.prices_html}</span>`:""}</span>`}updatePrice(t,e,i=!0){this.$booking_price.attr("data-booking_price",parseFloat(t)),this.$booking_price.attr("data-booking_regular_price",parseFloat(e)),this.$booking_price.html(this.getPriceHtml(i))}updateTotals(){this.hasSelectedDates()?this.calcBookingPrice():(this.$booking_price.find(".price .amount").html(EasyBooking.Helper.formatPrice(this.getPrice())),this.$booking_price.find(".price del .amount").html(EasyBooking.Helper.formatPrice(this.getRegularPrice())))}handleMultipleProductSelection(e,i,a){var r=this;let s="init",o=Object.keys(r.product.selectedIDs),n=Object.keys(e);o.length===n.length&&o.every((t,e)=>t===n[e])&&t.each(r.product.selectedIDs,function(t,i){return s=e[t]!==i&&"update","update"!==s}),"init"===s?(r.init(),r.updatePrice(i,a)):"update"===s&&(r.hasSelectedDates()?r.calcBookingPrice():r.updatePrice(i,a))}getAdditionalCosts(e="total"){var i=this;if(void 0===i.PAO_form)return 0;if("total"===e)return i.PAO_form.totals.total;let a=[];return t.each(i.PAO_form.totals.addons_price_data,function(t,e){let r=e.nameFormattedHTML.split('<span class="wc-pao-addon-name">').pop().split("</span>")[0],s=e.nameFormattedHTML.split('<span class="wc-pao-addon-value">').pop().split("</span>")[0],o=e.cost_raw_pu?e.cost_raw_pu:e.cost_raw,n=i.$cart.find(`.wc-pao-addon-name[data-addon-name="${r}"]`).parents(".wc-pao-addon").attr("class").match(/(?:^|\s)wc-pao-addon-id-([^- ]+)(?:\s|$)/)[1];a.push({id:n,cost:o,value:s})}),a}}class a{constructor(e){return!t.isEmptyObject(e)&&(this.id=e.$cart.find('input[name="add-to-cart"], button[name="add-to-cart"]').val(),void 0!==this.id&&(this.booking_dates=EASYBOOKING.product_params[this.id].booking_dates,this.booking_duration=parseInt(EASYBOOKING.product_params[this.id].booking_duration),this.children=EASYBOOKING.product_params[this.id].children,this.end_text=EASYBOOKING.product_params[this.id].end_text,this.first_date=parseInt(EASYBOOKING.product_params[this.id].first_date),this.last_date=parseInt(EASYBOOKING.product_params[this.id].last_date),this.max=""!==EASYBOOKING.product_params[this.id].max?parseInt(EASYBOOKING.product_params[this.id].max):"",this.min=parseInt(EASYBOOKING.product_params[this.id].min),this.price_suffix=EASYBOOKING.product_params[this.id].price_suffix,this.prices_html=EASYBOOKING.product_params[this.id].prices_html,this.product_type=EASYBOOKING.product_params[this.id].product_type,this.select_dates_message=EASYBOOKING.product_params[this.id].select_dates_message,this.start_text=EASYBOOKING.product_params[this.id].start_text,this.prices=EASYBOOKING.product_params[this.id].prices,this.regular_prices=EASYBOOKING.product_params[this.id].regular_prices,void(this.selectedIDs={})))}}class r{constructor(t,e="start"){this.type=e,this.$cart=t.$cart,this.$reset_dates=t.$reset_dates,this.$input="start"===this.type?t.$inputStart:t.$inputEnd,this.pickerObject=this.$input.pickadate("picker"),this.pickerItem=this.pickerObject.component.item,this.product=t.product,this.disabled=[]}clear(){this.pickerItem.clear=null,this.pickerItem.select=void 0,this.pickerObject.$node.val("")}reset(){let t=this.getMinimum(),e=this.getMaximum();this.pickerItem.disable=this.getDisabled(),this.pickerItem.min=EasyBooking.DateHelper.createDateObject(t),this.pickerItem.max=EasyBooking.DateHelper.createDateObject(e),this.pickerItem.highlight=EasyBooking.DateHelper.createDateObject(t),this.pickerItem.view=EasyBooking.DateHelper.createDateObject(new Date(t.getFullYear(),t.getMonth(),1)),this.pickerObject.render()}display(){this.pickerObject.$root.find(".picker__box").prepend(`<div class="picker__title">${"start"===this.type?this.product.start_text:this.product.end_text}</div>`)}set(t){void 0!==t.clear&&null===t.clear?("two"===this.product.booking_dates&&(this.otherPicker.reset(),this.otherPicker.isSet()||this.$reset_dates.hide()),this.$cart.trigger(`clear_${this.type}_date`)):void 0!==t.select&&"two"===this.product.booking_dates&&(this.otherPicker.update(),this.$reset_dates.show())}update(){if(!this.otherPicker.isSet())return;let t=this.getMinimum(),e=this.getMaximum(),i=this.getClosestDisabled();i&&("end"===this.type&&i<e||"start"===this.type&&i>t)&&("end"===this.type?e=i:t=i),this.pickerItem.min=EasyBooking.DateHelper.createDateObject(t),this.pickerItem.max=EasyBooking.DateHelper.createDateObject(e);let a=new Date(t);for(;!0===EasyBooking.DateHelper.isDisabled(this.getDisabled(),a);)a.setDate(a.getDate()+1);this.pickerItem.highlight=EasyBooking.DateHelper.createDateObject(a),this.pickerItem.view=EasyBooking.DateHelper.createDateObject(new Date(a.getFullYear(),a.getMonth(),1)),this.$cart.trigger(`set_${this.type}_picker`),this.pickerObject.render()}close(){var e=this;t(document.activeElement).trigger("blur"),"two"===e.product.booking_dates&&e.isSet()&&!e.otherPicker.isSet()&&setTimeout(function(){e.otherPicker.pickerObject.open()},250)}getSelected(){return!!this.isSet()&&new Date(this.pickerItem.select.pick)}getFirstAvailableDate(){let t=new Date,e="start"===this.type?+parseInt(this.product.first_date):parseInt(this.product.first_date+this.product.min);for(e>0&&t.setDate(t.getDate()+e);!0===EasyBooking.DateHelper.isDisabled(this.getDisabled(),t);)t.setDate(t.getDate()+1);return t instanceof Date?t:new Date(t)}getLastAvailableDate(){let t=new Date;return this.product.last_date>0&&t.setDate(t.getDate()+this.product.last_date),t instanceof Date?t:new Date(t)}getMinimum(){let t=this.otherPicker.getSelected(),e=t||new Date;if(t)"start"===this.type?e=""!==this.product.max?EasyBooking.DateHelper.removeDays(t,this.product.max):this.getFirstAvailableDate():"end"===this.type&&(e=EasyBooking.DateHelper.addDays(t,this.product.min));else{let t="start"===this.type?+parseInt(this.product.first_date):parseInt(this.product.first_date+this.product.min);t>0&&(e=EasyBooking.DateHelper.addDays(e,t))}for(;!0===EasyBooking.DateHelper.isDisabled(this.getDisabled(),e);)e=EasyBooking.DateHelper.addDays(e,1);return e instanceof Date?e:new Date(e)}getMaximum(){let t=this.getLastAvailableDate(),e=this.otherPicker.getSelected(),i=e||t;return"start"===this.type?i.setDate(i.getDate()-this.product.min):"end"===this.type&&(i=""!==this.product.max?i.setDate(i.getDate()+this.product.max):t),t<i&&(i=t),i instanceof Date?i:new Date(i)}getDisabled(){return this.disabled}applyBookingDuration(t=!1){let e=this.otherPicker.getSelected();if(!e||1===this.product.booking_duration)return;let i=new Date(this.pickerItem.view.pick),a=new Date(this.pickerItem.view.year,this.pickerItem.view.month+1,0),r=i.getDay();"monday"===EasyBooking.firstWeekday&&(r=0===r?6:r-1);let s=42-(a.getDate()+r),o,n;t?(o=EasyBooking.DateHelper.addDays(a,s),n=EasyBooking.DateHelper.removeDays(i,r),o>e&&(o=e)):(o=EasyBooking.DateHelper.removeDays(i,r),n=EasyBooking.DateHelper.addDays(a,s),o<e&&(o=e));let c=Math.abs(Math.round((e.getTime()-o.getTime())/864e5));"days"===EasyBooking.calcMode&&(c+=1);let d=c%this.product.booking_duration,p=o;d>0&&(p=t?EasyBooking.DateHelper.removeDays(o,this.product.booking_duration-d):EasyBooking.DateHelper.addDays(o,this.product.booking_duration-d));let l=this.getDisabled(),h=t?[{from:n,to:o}]:[{from:o,to:n}],u=!0,g=p;for(let e=0;e<42;e+=this.product.booking_duration){let i=0===e?p:t?EasyBooking.DateHelper.removeDays(p,e):EasyBooking.DateHelper.addDays(p,e);void 0!==l&&l.length>0&&!0===EasyBooking.DateHelper.isDisabled(l,i)||(u&&(g=i),h.push([i.getFullYear(),i.getMonth(),i.getDate(),"inverted"]),u=!1)}this.pickerItem.highlight=EasyBooking.DateHelper.createDateObject(new Date(g.getFullYear(),g.getMonth(),g.getDate())),this.pickerItem.disable=l.concat(h)}getClosestDisabled(){const t=this.otherPicker.pickerItem.select.pick,e=new Date(t);let i=e.getDay();"sunday"===EasyBooking.firstWeekday&&(i+=1);const a=this.pickerObject.get("disable"),r=this.otherPicker.pickerObject.get("disable"),s="no"===EasyBooking.allowDisabled?a.concat(r):a,o=new Set;s.forEach(a=>{if(!EasyBooking.DateHelper.isArray(a)||"booked"!==a[3]&&"no"!==EasyBooking.allowDisabled)if(!EasyBooking.DateHelper.isObject(a)||"booked"!==a.type&&"no"!==EasyBooking.allowDisabled){if(EasyBooking.DateHelper.isDate(a))o.add(a.getTime());else if("no"===EasyBooking.allowDisabled&&EasyBooking.DateHelper.isDay(a)){let r=Math.abs(i-a);r=0===r?7:r,"end"===this.type?(a<i&&7!==r&&(r=7-r),o.add(e.setDate(e.getDate()+r))):"start"===this.type&&(i<a&&7!==r&&(r=7-r),o.add(e.setDate(e.getDate()-r))),e.setTime(t)}}else{const t="end"===this.type?new Date(a.from[0],a.from[1],a.from[2]):new Date(a.to[0],a.to[1],a.to[2]);o.add(t.getTime())}else o.add(new Date(a[0],a[1],a[2]).getTime())});const n=Array.from(o).sort((t,e)=>"end"===this.type?t-e:e-t),c=n.find(e=>"end"===this.type?e>t:e<t);return!!c&&new Date(c)}isSet(){return void 0!==this.pickerItem.select&&null!==this.pickerItem.select}}class s{constructor(){this.nonce=null}async fetchFreshNonce(){const t=await fetch(EASYBOOKING.rest_url+"easybooking/v1/get-fresh-nonce/"),e=await t.json();if(e.nonce)return this.nonce=e.nonce,this.nonce;throw new Error("Something went wrong. Please refresh the page and try again.")}async getNonce(){return this.nonce?this.nonce:await this.fetchFreshNonce()}}return{Datepickers:i,Picker:r,DynamicNonce:s}}(),EasyBooking.datepickersClass=(t=>{const e=["simple","variable","grouped","bundle"];if(e.includes(t))return"undefined"!=typeof EasyBookingPro?EasyBookingPro[`${t.charAt(0).toUpperCase()+t.slice(1)}Datepickers`]:EasyBooking.Datepickers.Datepickers;throw new Error("Product type is incorrect!")})})(jQuery,window);